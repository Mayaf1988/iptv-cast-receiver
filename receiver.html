<!DOCTYPE html>
<html>
<head>
    <title>IPTV Cast Receiver</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        cast-media-player {
            width: 100%;
            height: 100%;
        }
        #debug {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 20px;
            font-size: 24px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            z-index: 9999;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        #debug.show {
            display: block;
        }
        .error {
            color: #ff0000;
            font-weight: bold;
        }
        .success {
            color: #00ff00;
        }
        .info {
            color: #00d9ff;
        }
    </style>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>
    <cast-media-player></cast-media-player>
    <div id="debug"></div>
    
    <script>
        // Visual debug logger
        const debugDiv = document.getElementById('debug');
        let debugMessages = [];
        
        function showDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            debugMessages.push(`<div class="${className}">[${timestamp}] ${message}</div>`);
            
            // Keep only last 10 messages
            if (debugMessages.length > 10) {
                debugMessages.shift();
            }
            
            debugDiv.innerHTML = debugMessages.join('');
            debugDiv.classList.add('show');
            
            // Auto-hide debug after 10 seconds if playing successfully
            if (type === 'success') {
                setTimeout(() => {
                    debugDiv.classList.remove('show');
                }, 10000);
            }
        }

        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        showDebug('Cast receiver starting...', 'info');

        // Intercept LOAD requests
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (loadRequestData) => {
                try {
                    showDebug('ðŸ“¥ Load request received', 'info');
                    
                    if (loadRequestData.media && loadRequestData.media.contentUrl) {
                        let url = loadRequestData.media.contentUrl;
                        showDebug(`Original URL: ${url.substring(0, 60)}...`, 'info');
                        
                        // Handle pipe-separated headers
                        if (url.includes('|')) {
                            const parts = url.split('|');
                            url = parts[0];
                            showDebug(`âœ‚ï¸ Removed headers, cleaned URL`, 'info');
                        }
                        
                        // Remove .0 from extension
                        const originalUrl = url;
                        url = url.replace(/\.0\.(m3u8|ts)$/i, '.$1');
                        
                        if (originalUrl !== url) {
                            showDebug(`âœ‚ï¸ Fixed .0 extension`, 'success');
                            showDebug(`New URL: ${url.substring(url.length - 40)}`, 'info');
                        }
                        
                        loadRequestData.media.contentUrl = url;
                        
                        // Set content type
                        let contentType;
                        if (url.includes('.m3u8')) {
                            contentType = 'application/x-mpegURL';
                            showDebug(`ðŸ“ Type: HLS (m3u8)`, 'info');
                        } else if (url.includes('.ts')) {
                            contentType = 'application/x-mpegURL';
                            showDebug(`ðŸ“ Type: HLS (ts treated as HLS)`, 'info');
                        } else if (url.includes('.mp4')) {
                            contentType = 'video/mp4';
                            showDebug(`ðŸ“ Type: MP4`, 'info');
                        } else {
                            contentType = 'application/x-mpegURL';
                            showDebug(`ðŸ“ Type: Default HLS`, 'info');
                        }
                        
                        loadRequestData.media.contentType = contentType;
                        showDebug(`âœ… Ready to load stream`, 'success');
                    }
                    
                    return loadRequestData;
                    
                } catch (error) {
                    showDebug(`âŒ ERROR: ${error.message}`, 'error');
                    return loadRequestData;
                }
            }
        );

        // Handle errors
        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (event) => {
                const errorCode = event.detailedErrorCode || event.error?.code || 'UNKNOWN';
                const errorMsg = event.error?.message || 'Unknown error';
                showDebug(`âŒ PLAYER ERROR: ${errorCode}`, 'error');
                showDebug(`Details: ${errorMsg}`, 'error');
                
                // Keep error visible
                setTimeout(() => {
                    debugDiv.classList.add('show');
                }, 1000);
            }
        );

        // Load complete
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
            () => {
                showDebug(`âœ… Stream loaded successfully!`, 'success');
            }
        );

        // Playing
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYING,
            () => {
                showDebug(`â–¶ï¸ Playback started!`, 'success');
                // Hide debug after 5 seconds of successful playback
                setTimeout(() => {
                    debugDiv.classList.remove('show');
                }, 5000);
            }
        );

        // Buffering
        playerManager.addEventListener(
            cast.framework.events.EventType.BUFFERING,
            () => {
                showDebug(`â³ Buffering...`, 'info');
            }
        );

        // Start receiver
        const options = new cast.framework.CastReceiverOptions();
        options.maxInactivity = 3600;
        options.disableIdleTimeout = false;
        options.supportedCommands = cast.framework.messages.Command.ALL_BASIC_MEDIA;
        
        context.start(options);
        showDebug(`âœ… Receiver ready!`, 'success');
        
        // Hide initial message after 3 seconds
        setTimeout(() => {
            if (debugMessages.length <= 2) {
                debugDiv.classList.remove('show');
            }
        }, 3000);
    </script>
</body>
</html>
